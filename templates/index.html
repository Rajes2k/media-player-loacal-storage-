<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rajes Media Player</title>
<style>
  :root{
    --bg-dark:#0b0f12;
    --panel-dark:#14181b;
    --muted-dark:rgba(255,255,255,0.88);
    --muted-sub:#cfd8dc;
    --accent:#00bcd4;
    --card-shadow: 0 10px 30px rgba(0,0,0,0.45);

    --bg-light:#f6f7f9;
    --panel-light:#ffffff;
    --muted-light:#111827;
    --card-shadow-light:0 8px 24px rgba(0,0,0,0.06);
  }
  /* Base */
  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Arial, sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  body{background:var(--bg-dark);color:var(--muted-dark);transition:background .25s,color .25s}
  body.light{background:var(--bg-light);color:var(--muted-light)}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:var(--panel-dark);box-shadow:var(--card-shadow)}
  body.light header{background:var(--panel-light);box-shadow:var(--card-shadow-light)}
  h1{margin:0;color:var(--accent);font-size:18px;display:flex;align-items:center;gap:8px}

  /* Controls row */
  .controls-row{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;gap:12px;flex-wrap:wrap}
  .controls-left, .controls-right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;display:inline-flex;align-items:center;gap:8px}
  .btn.ghost{background:transparent;border:2px solid var(--accent);color:var(--accent);padding:6px 10px}
  input[type=file]{display:none}

  /* Indicators */
  .indicator{display:inline-flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;background:transparent;border:2px solid transparent;font-weight:700}
  .indicator .icon{font-size:18px}

  /* gallery */
  .gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;padding:18px;max-width:1200px;margin:0 auto}
  .gallery.list{display:flex;flex-direction:column;padding:10px 18px}

  .card{background:var(--panel-dark);border-radius:12px;overflow:hidden;box-shadow:var(--card-shadow);transition:transform .18s ease,box-shadow .18s ease,opacity .25s;display:flex;flex-direction:column}
  body.light .card{background:var(--panel-light);box-shadow:var(--card-shadow-light)}
  .card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(0,0,0,0.35)}
  .card.row{flex-direction:row;align-items:center;padding:8px;height:110px}

  .thumb-wrap{position:relative;flex:0 0 160px;height:90px;overflow:hidden;border-radius:10px;margin:12px;background:#000}
  .thumb{width:100%;height:100%;object-fit:cover;display:block;background:#000}
  .duration-badge{position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,0.7);color:#fff;padding:4px 6px;border-radius:6px;font-weight:700;font-size:12px}

  .progress-small{position:absolute;left:0;right:0;bottom:0;height:6px;background:rgba(255,255,255,0.06)}
  .progress-small .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#ff5a5a)} /* red-ish gradient end */

  .meta{padding:10px;text-align:left;display:flex;flex-direction:column;gap:6px;flex:1}
  .meta h3{margin:0;font-size:15px;color:var(--muted-dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  body.light .meta h3{color:var(--muted-light)}
  .meta .tags{display:flex;gap:8px;flex-wrap:wrap}
  .tag{background:rgba(0,0,0,0.35);color:#fff;padding:6px 8px;border-radius:6px;font-weight:700;font-size:12px}
  body.light .tag{background:rgba(0,0,0,0.06);color:var(--muted-light)}
  .detail-row{display:flex;gap:12px;flex-wrap:wrap;font-size:13px;color:var(--muted-dark)}
  body.light .detail-row{color:var(--muted-light)}

  /* player overlay */
  #player-container{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:9999;align-items:center;justify-content:center;padding:18px}
  #player-box{width:100%;max-width:1100px;max-height:calc(100vh - 140px);display:flex;flex-direction:column;align-items:center;gap:12px}
  #player{width:100%;height:auto;background:#000;border-radius:8px;outline:none;max-height:calc(100vh - 220px);object-fit:contain}
  #audioPlayer{width:100%;display:none}
  #close{position:absolute;right:18px;top:12px;font-size:22px;color:#fff;background:transparent;border:none;cursor:pointer}

  /* sticky bottom on small screens adjust */
  @media (max-width:760px){
    #audio-bar{left:8px;right:8px;bottom:8px;height:64px}
    .thumb-wrap{flex:0 0 120px;height:72px;margin:8px}
    .card.row{height:auto;padding:8px}
  }

  /* subtle fade-in */
  .card{opacity:1}
  .fade-in{opacity:0;transform:translateY(6px);animation:fadeUp .45s forwards}
  @keyframes fadeUp{to{opacity:1;transform:none}}

</style>
</head>
<body>
  <header>
    <h1>üé¨ Rajes Media Player</h1>
    <div style="display:flex;gap:10px;align-items:center">
      <span id="themeIndicator" class="indicator" title="Theme"><span class="icon">üåô</span></span>
      <span id="viewIndicator" class="indicator" title="View"><span class="icon">üî≤</span></span>
    </div>
  </header>

  <div class="controls-row">
    <div class="controls-left">
      <label class="btn" for="fileInput">üìÇ Select Files</label>
      <input id="fileInput" type="file" accept="video/*,audio/*" multiple>

      <label class="btn" for="folderInput">üìÅ Select Folder</label>
      <input id="folderInput" type="file" accept="video/*,audio/*" webkitdirectory>

      <select id="typeFilter" class="btn ghost" title="Filter type">
        <option value="all">All types</option>
        <option value="video">Video</option>
        <option value="audio">Audio</option>
      </select>

      <select id="sortSelect" class="btn ghost" title="Sort">
        <option value="type">Sort: Type</option>
        <option value="title">Title</option>
        <option value="date">Date</option>
        <option value="length">Length</option>
        <option value="size">Size</option>
        <option value="resolution">Resolution</option>
      </select>
    </div>

    <div class="controls-right">
      <button id="viewToggle" class="btn ghost" title="Toggle grid/list">üî≤ Grid</button>
      <button id="themeToggle" class="btn ghost" title="Toggle theme">üåô Dark</button>
    </div>
  </div>

  <main>
    <div id="gallery" class="gallery"></div>
  </main>

  <!-- Player overlay -->
  <div id="player-container" role="dialog" aria-hidden="true">
    <div id="player-box">
      <button id="close" title="Close">‚úñ</button>
      <video id="player" controls playsinline webkit-playsinline></video>
      <audio id="audioPlayer" controls style="display:none"></audio>
      <div id="player-meta" style="color:#fff;font-size:13px;width:100%;text-align:left"></div>
    </div>
  </div>

  <footer style="padding:14px;text-align:center;color:rgba(255,255,255,0.45)">¬© 2025 Rajes Media Player ‚Äî Local media only</footer>

<script>
/* ------------------ State ------------------ */
const galleryEl = document.getElementById('gallery');
const fileInput = document.getElementById('fileInput');
const folderInput = document.getElementById('folderInput');
const typeFilter = document.getElementById('typeFilter');
const sortSelect = document.getElementById('sortSelect');
const viewToggle = document.getElementById('viewToggle');
const themeToggle = document.getElementById('themeToggle');
const viewIndicator = document.getElementById('viewIndicator');
const themeIndicator = document.getElementById('themeIndicator');

const playerContainer = document.getElementById('player-container');
const player = document.getElementById('player');
const audioPlayer = document.getElementById('audioPlayer');
const closeBtn = document.getElementById('close');
const playerMeta = document.getElementById('player-meta');

const audioBar = document.getElementById('audio-bar');
const audioThumb = document.getElementById('audio-thumb');
const audioTitle = document.getElementById('audio-title');

let allFiles = []; // {file, url, metadata:{duration,width,height,fps,size,date}, thumbUrl, played}
let isListView = false;
let isLight = false;

/* audio playlist state */
let audioList = []; // indices into allFiles for audio files
let currentAudioIndex = -1;
let isShuffle = false;
let isAutoplay = false;

/* ------------------ Helpers ------------------ */
function formatBytes(bytes){
  if(bytes===0) return '0 B';
  const k=1024, sizes=['B','KB','MB','GB','TB'];
  const i=Math.floor(Math.log(bytes)/Math.log(k));
  return parseFloat((bytes/Math.pow(k,i)).toFixed(2))+' '+sizes[i];
}
function formatTime(s){
  s = Number(s) || 0;
  const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = Math.floor(s%60);
  if(h>0) return `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
  return `${m}:${String(sec).padStart(2,'0')}`;
}

/* ----------- Thumbnail capture at 1/4 duration ----------- */
async function captureThumbnail(url){
  return new Promise((resolve)=>{
    const v = document.createElement('video');
    v.crossOrigin = 'anonymous';
    v.muted = true;
    v.preload = 'metadata';
    v.src = url;
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    let done=false;
    function cleanup(){ try{ v.src=''; v.load(); }catch(e){} }
    v.addEventListener('loadedmetadata', ()=>{
      const t = Math.max(0.1, (v.duration || 0) * 0.25);
      canvas.width = Math.min(640, v.videoWidth || 640);
      canvas.height = Math.round(canvas.width * ((v.videoHeight||360)/(v.videoWidth||640)));
      v.currentTime = Math.min(t, v.duration || t);
      v.addEventListener('seeked', ()=>{
        try{
          ctx.drawImage(v,0,0,canvas.width,canvas.height);
          const dataUrl = canvas.toDataURL('image/jpeg',0.75);
          if(!done){ done=true; cleanup(); resolve({thumb:dataUrl,width:v.videoWidth,height:v.videoHeight}); }
        }catch(e){
          if(!done){ done=true; cleanup(); resolve({thumb:null,width:v.videoWidth,height:v.videoHeight}); }
        }
      }, {once:true});
      // fallback timeout
      setTimeout(()=>{ if(!done){ try{ ctx.drawImage(v,0,0,canvas.width,canvas.height); }catch(_){} done=true; cleanup(); resolve({thumb:canvas.toDataURL('image/jpeg',0.7), width:v.videoWidth, height:v.videoHeight}); } }, 900);
    }, {once:true});
    v.addEventListener('error', ()=>{ if(!done){ done=true; cleanup(); resolve({thumb:null,width:0,height:0}); } }, {once:true});
  });
}

/* ---------- Estimate FPS (best-effort) ---------- */
async function estimateFPS(url, duration){
  return new Promise((resolve)=>{
    try{
      const v = document.createElement('video'); v.preload='metadata'; v.muted=true; v.src=url;
      v.addEventListener('loadedmetadata', ()=>{
        // attempt to play briefly to get frames info
        const finish = ()=>{
          try{
            if(typeof v.getVideoPlaybackQuality === 'function'){
              const q = v.getVideoPlaybackQuality();
              if(q && q.totalVideoFrames && duration > 0){
                resolve(Math.round(q.totalVideoFrames / Math.max(1,duration)));
                v.src='';
                return;
              }
            }
            const frames = v.webkitDecodedFrameCount || v.mozPaintCount || 0;
            if(frames && duration > 0){
              resolve(Math.round(frames/duration));
              v.src=''; return;
            }
            resolve('Unknown');
            v.src='';
          }catch(e){ resolve('Unknown'); v.src=''; }
        };
        v.play().then(()=>{ setTimeout(()=>{ v.pause(); finish(); }, 300); }).catch(()=>{ finish(); });
      }, {once:true});
      v.addEventListener('error', ()=>resolve('Unknown'), {once:true});
    }catch(e){ resolve('Unknown'); }
  });
}

/* ---------------- Build card ---------------- */
function buildCard(item, idx){
  const isVideo = item.file.type.startsWith('video/');
  const card = document.createElement('div');
  card.className = 'card fade-in';
  if(isListView) card.classList.add('row');

  const thumbWrap = document.createElement('div'); thumbWrap.className='thumb-wrap';
const img = document.createElement('img'); 
img.className='thumb'; 
img.alt = item.file.name;

if(item.thumbUrl) {
  img.src = item.thumbUrl;
  thumbWrap.appendChild(img);
} else {
  if(item.file.type.startsWith('audio/')) {
    // show audio emoji thumbnail for audio files
    const emojiDiv = document.createElement('div');
    emojiDiv.style.width = '100%';
    emojiDiv.style.height = '100%';
    emojiDiv.style.display = 'flex';
    emojiDiv.style.alignItems = 'center';
    emojiDiv.style.justifyContent = 'center';
    emojiDiv.style.fontSize = '40px';
    emojiDiv.textContent = 'üéµ';
    thumbWrap.appendChild(emojiDiv);
  } else {
    img.src = ''; // blank for videos with no thumbnail
    thumbWrap.appendChild(img);
  }
}

  const durBadge = document.createElement('div'); durBadge.className='duration-badge';
  durBadge.textContent = item.metadata.duration ? formatTime(item.metadata.duration) : '00:00';
  thumbWrap.appendChild(durBadge);

  const progressSmall = document.createElement('div'); progressSmall.className='progress-small';
  const bar = document.createElement('div'); bar.className='bar';
  bar.style.width = ( (item.played && item.metadata.duration) ? Math.min(100, (item.played / item.metadata.duration)*100) : 0 ) + '%';
  progressSmall.appendChild(bar);
  thumbWrap.appendChild(progressSmall);

  const meta = document.createElement('div'); meta.className='meta';
  const title = document.createElement('h3'); title.textContent = item.file.name;
  const tagRow = document.createElement('div'); tagRow.className='tags';
  const tagType = document.createElement('span'); tagType.className='tag'; tagType.textContent = item.file.type.split('/')[0].toUpperCase();
  tagRow.appendChild(tagType);

  const details = document.createElement('div'); details.className='detail-row';
  const lengthEl = document.createElement('div'); lengthEl.textContent = 'Length: ' + (item.metadata.duration? formatTime(item.metadata.duration) : 'Unknown');
  const resEl = document.createElement('div'); resEl.textContent = 'Res: ' + (item.metadata.width? `${item.metadata.width}x${item.metadata.height}` : 'Unknown');
  const fpsEl = document.createElement('div'); fpsEl.textContent = 'FPS: ' + (item.metadata.fps || 'Unknown');
  const sizeEl = document.createElement('div'); sizeEl.textContent = 'Size: ' + (item.file.size ? formatBytes(item.file.size) : 'Unknown');
  const dateEl = document.createElement('div'); dateEl.textContent = 'Date: ' + new Date(item.file.lastModified).toLocaleDateString();
  const playedEl = document.createElement('div'); playedEl.textContent = 'Played: ' + (item.played ? formatTime(item.played) : '0:00');

  details.append(lengthEl,resEl,fpsEl,sizeEl,dateEl,playedEl);
  meta.append(title, tagRow, details);

  // click to open
  const openPlayer = (e)=>{
    e.stopPropagation();
    openInPlayer(idx);
  };
  thumbWrap.addEventListener('click', openPlayer);
  meta.addEventListener('click', openPlayer);

  card.appendChild(thumbWrap);
  card.appendChild(meta);
  return card;
}

/* ---------------- Render gallery ---------------- */
function renderGallery(){
  galleryEl.innerHTML = '';
  const filter = typeFilter.value;
  let filesToShow = allFiles.filter(it => (filter==='all' ? true : it.file.type.startsWith(filter)));
  const sortBy = sortSelect.value;

  filesToShow.sort((a,b)=>{
    if(sortBy==='title') return a.file.name.localeCompare(b.file.name);
    if(sortBy==='type') return a.file.type.localeCompare(b.file.type);
    if(sortBy==='date') return a.file.lastModified - b.file.lastModified;
    if(sortBy==='size') return a.file.size - b.file.size;
    if(sortBy==='length') return (a.metadata.duration || 0) - (b.metadata.duration || 0);
    if(sortBy==='resolution'){
      const ra = (a.metadata.width||0)*(a.metadata.height||0);
      const rb = (b.metadata.width||0)*(b.metadata.height||0);
      return rb - ra;
    }
    return 0;
  });

  galleryEl.classList.toggle('list', isListView);
  filesToShow.forEach((it, idx)=>{
    const card = buildCard(it, idx);
    galleryEl.appendChild(card);
  });
}

/* ---------------- Open in native player overlay ---------------- */
function openInPlayer(index){
  const item = allFiles[index];
  if(!item) return;
  const isVideo = item.file.type.startsWith('video/');
  // close audio bar if playing other audio? keep it independent
  playerContainer.style.display = 'flex';
  playerContainer.setAttribute('aria-hidden','false');

  // cleanup previous
  try{ player.pause(); audioPlayer.pause(); } catch(e){}

  if(isVideo){
    audioPlayer.style.display = 'none';
    player.style.display = 'block';
    player.src = item.url;
    player.currentTime = item.played || 0;
    // meta
    playerMeta.textContent = `${item.file.name} ‚Ä¢ ${item.metadata.width ? item.metadata.width + 'x' + item.metadata.height : 'Res unknown'} ‚Ä¢ ${item.file.size? formatBytes(item.file.size) : ''}`;
    player.play().catch(()=>{}); // may require gesture
    // track play progress for thumbnail progress bar
    player.ontimeupdate = ()=>{ item.played = player.currentTime; updateSmallProgressFor(item); renderGallery(); };
  } else {
    player.style.display = 'none';
    audioPlayer.style.display = 'block';
    audioPlayer.src = item.url;
    audioPlayer.currentTime = item.played || 0;
    playerMeta.textContent = `${item.file.name} ‚Ä¢ Audio ‚Ä¢ ${item.file.size? formatBytes(item.file.size) : ''}`;
    audioPlayer.play().catch(()=>{});
    audioPlayer.ontimeupdate = ()=>{ item.played = audioPlayer.currentTime; renderGallery(); updateAudioBarUI(); };
    // ensure audio bar shows
    const audioIdx = allFiles.indexOf(item);
    if(audioIdx>=0){
      const pos = audioList.indexOf(audioIdx);
      if(pos>=0) currentAudioIndex = pos;
      else {
        // if audio not in playlist yet, rebuild playlist and set current
        rebuildAudioList();
        currentAudioIndex = audioList.indexOf(allFiles.indexOf(item));
      }
      showAudioBar();
    }
  }
}

/* update small progress bar for a single item (thumbnail) */
function updateSmallProgressFor(item){
  // find corresponding card and update its small bar if present
  // simpler approach: re-render gallery (already done elsewhere)
}

/* ---------------- Ingest files ---------------- */
async function ingestFiles(fileList){
  for(const f of fileList){
    if(!f.type || (!f.type.startsWith('video/') && !f.type.startsWith('audio/'))) continue;
    const url = URL.createObjectURL(f);
    const entry = {file: f, url: url, metadata:{}, thumbUrl:null, played:0};
    entry.metadata.size = f.size;
    entry.metadata.date = f.lastModified;

    if(f.type.startsWith('video/')){
      try{
        const {thumb,width,height} = await captureThumbnail(url);
        entry.thumbUrl = thumb;
        entry.metadata.width = width;
        entry.metadata.height = height;
      }catch(e){ entry.thumbUrl = null; }
      // load duration via temporary element
      const v = document.createElement('video'); v.preload='metadata'; v.muted=true; v.src=url;
      await new Promise((res)=>{ v.addEventListener('loadedmetadata', ()=>res(), {once:true}); v.addEventListener('error', ()=>res(), {once:true}); });
      entry.metadata.duration = v.duration || 0;
      entry.metadata.fps = await estimateFPS(url, entry.metadata.duration);
    } else {
      const a = document.createElement('audio'); a.preload='metadata'; a.src = url;
      await new Promise((res)=>{ a.addEventListener('loadedmetadata', ()=>res(), {once:true}); a.addEventListener('error', ()=>res(), {once:true}); });
      entry.metadata.duration = a.duration || 0;
      // audio thumbnail default will be icon
      entry.thumbUrl = null;
    }
    allFiles.push(entry);
    // small render update for best UX
    renderGallery();
  }
  // rebuild audio list
  rebuildAudioList();
  renderGallery();
}

/* ---------------- Filtering / Sorting UI ---------------- */
fileInput.addEventListener('change', async (e)=>{ const files = Array.from(e.target.files||[]); await ingestFiles(files); });
folderInput.addEventListener('change', async (e)=>{ const files = Array.from(e.target.files||[]); await ingestFiles(files); });
typeFilter.addEventListener('change', ()=>renderGallery());
sortSelect.addEventListener('change', ()=>renderGallery());

/* ---------------- View & Theme toggles ---------------- */
viewToggle.addEventListener('click', ()=>{
  isListView = !isListView;
  viewToggle.textContent = isListView ? 'üìã List' : 'üî≤ Grid';
  viewIndicator.querySelector('.icon').textContent = isListView ? 'üìã' : 'üî≤';
  renderGallery();
});
themeToggle.addEventListener('click', ()=>{
  isLight = !isLight;
  document.body.classList.toggle('light', isLight);
  themeToggle.textContent = isLight ? '‚òÄÔ∏è Light' : 'üåô Dark';
  themeIndicator.querySelector('.icon').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
});

/* ---------------- Player close ---------------- */
closeBtn.addEventListener('click', ()=>{
  try{ player.pause(); audioPlayer.pause(); }catch(e){}
  playerContainer.style.display = 'none';
  playerContainer.setAttribute('aria-hidden','true');
});


/* track audio time updates to keep played time saved */
audioPlayer.addEventListener('timeupdate', ()=>{
  const curItem = allFiles[audioList[currentAudioIndex]];
  if(curItem) curItem.played = audioPlayer.currentTime;
});

/* ---------------- Fixes & behaviors ---------------- */
/* Ensure thumbnail durations show correct lengths by using metadata; progress bar uses item.played */
function refreshSmallBars(){
  // re-render gallery (cheap)
  renderGallery();
}

/* ---------------- Cleanup before unload ---------------- */
window.addEventListener('beforeunload', ()=>{
  allFiles.forEach(it => { try{ URL.revokeObjectURL(it.url); }catch(e){} });
});

/* ---------------- Accessibility: Esc to close ---------------- */
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ if(playerContainer.style.display==='flex') closeBtn.click(); }});

/* ---------------- Initialization ---------------- */
(function init(){
  viewToggle.textContent = 'üî≤ Grid';
  themeToggle.textContent = 'üåô Dark';
  themeIndicator.querySelector('.icon').textContent = 'üåô';
  viewIndicator.querySelector('.icon').textContent = 'üî≤';
  rebuildAudioList();
})();

</script>
</body>
</html>
