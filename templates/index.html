<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rajes Media Player</title>
<style>
  :root{
    --bg-dark:#0b0f12;
    --panel-dark:#14181b;
    --muted-dark:rgba(255,255,255,0.85);
    --accent:#00bcd4;
    --card-shadow: 0 6px 20px rgba(0,0,0,0.45);
    --watched-red: #ea4335;
    --bg-light:#f6f7f9;
    --panel-light:#ffffff;
    --muted-light:rgba(0,0,0,0.8);
  }

  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Arial, sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
  body{background:var(--bg-dark);color:var(--muted-dark);transition:background .25s,color .25s}
  body.light{background:var(--bg-light);color:var(--muted-light)}

  header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--panel-dark);box-shadow:var(--card-shadow);position:sticky;top:0;z-index:10}
  body.light header{background:var(--panel-light)}
  h1{margin:0;color:var(--accent);font-size:18px;display:flex;align-items:center;gap:8px}
  .top-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

  .btn { background:var(--accent); color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; display:inline-flex; align-items:center; gap:8px;}
  .btn.ghost { background:transparent; border:2px solid var(--accent); color:var(--accent); padding:6px 10px; }
  input[type="file"]{display:none;}

  .indicator{display:inline-flex;align-items:center;gap:8px;font-weight:700;padding:6px 8px;border-radius:8px;background:transparent;border:2px solid transparent}
  .indicator .icon{font-size:18px}

  .controls-row{padding:12px 16px;display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap}
  .controls-left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .controls-right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

  .gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;padding:18px;max-width:1200px;margin:0 auto}
  .gallery.list{display:flex;flex-direction:column;gap:10px;padding:10px 18px}

  .card{background:var(--panel-dark);border-radius:12px;overflow:hidden;box-shadow:var(--card-shadow);transition:transform .18s ease,box-shadow .18s ease;display:flex;flex-direction:column;position:relative;}
  body.light .card{background:var(--panel-light);box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  .card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(0,0,0,0.35)}

  .card.row{flex-direction:row;align-items:center;padding:8px;height:110px}
  .thumb-wrap{position:relative;flex:0 0 160px;height:90px;overflow:hidden;border-radius:10px;margin:10px;background:#000}
  .thumb{width:100%;height:100%;object-fit:cover;display:block}
  .duration-badge{position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,0.6);color:#fff;padding:4px 6px;border-radius:6px;font-weight:700;font-size:12px}

  .meta{padding:12px;text-align:left;display:flex;flex-direction:column;gap:6px;flex:1}
  .meta h3{margin:0;font-size:15px;color:var(--muted-dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  body.light .meta h3{color:var(--muted-light)}
  .meta .tags{display:flex;gap:8px;flex-wrap:wrap}
  .tag{background:rgba(0,0,0,0.35);color:#fff;padding:6px 8px;border-radius:6px;font-weight:700;font-size:12px}
  body.light .tag{background:rgba(0,0,0,0.06);color:var(--muted-light)}

  .meta .detail-row{display:flex;gap:12px;flex-wrap:wrap;font-size:13px;color:var(--muted-dark)}
  body.light .meta .detail-row{color:var(--muted-light)}

  /* watched progress bar under thumbnail (red line) */
  .watched-bar-wrap{position:absolute;left:0;right:0;bottom:0;height:6px;background:rgba(255,255,255,0.08)}
  .watched-bar{height:100%;width:0%;background:var(--watched-red);transition:width .25s linear}

  .pulse { animation: pulse 1.6s infinite; }
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}

  #player-container{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:9999;align-items:center;justify-content:center;padding:16px}
  #player-box{width:100%;max-width:1100px;max-height:92%;display:flex;flex-direction:column;align-items:center;gap:8px}
  #player{width:100%;height:auto;background:#000;border-radius:8px;outline:none}
  #audioPlayer{width:100%;display:none}
  #close{position:absolute;right:18px;top:12px;font-size:22px;color:#fff;background:transparent;border:none;cursor:pointer}

  footer{padding:12px;text-align:center;color:rgba(255,255,255,0.45)}

  @media (max-width:700px){
    .thumb-wrap{flex:0 0 120px;height:72px;margin:8px}
    .meta h3{font-size:14px}
    .gallery{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
  }
</style>
</head>
<body>
  <header>
    <h1>üé¨ Rajes Media Player</h1>
    <div class="top-actions">
      <span id="themeIndicator" class="indicator" title="Theme"><span class="icon">üåô</span></span>
      <span id="viewIndicator" class="indicator" title="View"><span class="icon">üî≤</span></span>
    </div>
  </header>

  <div class="controls-row">
    <div class="controls-left">
      <label class="btn" for="fileInput">üìÇ Select Files</label>
      <input id="fileInput" type="file" accept="video/*,audio/*" multiple>

      <label class="btn" for="folderInput">üìÅ Select Folder</label>
      <input id="folderInput" type="file" accept="video/*,audio/*" webkitdirectory>

      <select id="typeFilter" class="btn ghost" title="Filter type">
        <option value="all">All types</option>
        <option value="video">Video</option>
        <option value="audio">Audio</option>
      </select>

      <select id="sortSelect" class="btn ghost" title="Sort">
        <option value="type">Type</option>
        <option value="title">Title</option>
        <option value="date">Date</option>
        <option value="length">Length</option>
        <option value="size">Size</option>
      </select>
    </div>

    <div class="controls-right">
      <button id="viewToggle" class="btn ghost" title="Toggle grid/list">üî≤ Grid</button>
      <button id="themeToggle" class="btn ghost" title="Toggle theme">üåô Dark</button>
    </div>
  </div>

  <main>
    <div id="gallery" class="gallery"></div>
  </main>

  <div id="player-container" role="dialog" aria-hidden="true">
    <div id="player-box">
      <button id="close" title="Close">‚úñ</button>
      <video id="player" controls playsinline webkit-playsinline></video>
      <audio id="audioPlayer" controls></audio>
      <div id="player-meta" style="color:#fff;font-size:13px;width:100%;text-align:left"></div>
    </div>
  </div>

  <footer>¬© 2025 Rajes Media Player ‚Äî Your local media, remembered</footer>

<script>
/* ---------- State ---------- */
const galleryEl = document.getElementById('gallery');
const fileInput = document.getElementById('fileInput');
const folderInput = document.getElementById('folderInput');
const typeFilter = document.getElementById('typeFilter');
const sortSelect = document.getElementById('sortSelect');
const viewToggle = document.getElementById('viewToggle');
const themeToggle = document.getElementById('themeToggle');
const themeIndicator = document.getElementById('themeIndicator');
const viewIndicator = document.getElementById('viewIndicator');

const playerContainer = document.getElementById('player-container');
const player = document.getElementById('player');
const audioPlayer = document.getElementById('audioPlayer');
const closeBtn = document.getElementById('close');
const playerMeta = document.getElementById('player-meta');

let allFiles = []; // {file, url, metadata:{duration,width,height,size,date,fps}, thumbUrl, playedSeconds}
let isListView = false;
let isLight = false;

/* ---------- LocalStorage helpers for last-played positions ---------- */
function fileKey(file){
  // stable fingerprint: name|size|lastModified
  return `${file.name}|${file.size}|${file.lastModified}`;
}
function savePlayedPosition(file, seconds){
  try{
    const key = 'rmp_play_' + fileKey(file);
    localStorage.setItem(key, String(seconds || 0));
  }catch(e){}
}
function loadPlayedPosition(file){
  try{
    const key = 'rmp_play_' + fileKey(file);
    const v = localStorage.getItem(key);
    return v ? Number(v) : 0;
  }catch(e){ return 0; }
}

/* ---------- Utils ---------- */
function formatBytes(bytes){
  if(bytes === 0) return '0 B';
  const k = 1024, sizes = ['B','KB','MB','GB','TB'];
  const i = Math.floor(Math.log(bytes)/Math.log(k));
  return parseFloat((bytes/Math.pow(k,i)).toFixed(2)) + ' ' + sizes[i];
}
function formatTime(s){
  s = Number(s) || 0;
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const sec = Math.floor(s%60);
  if(h>0) return `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
  return `${m}:${String(sec).padStart(2,'0')}`;
}

/* ---------- Thumbnail capture at 1/4 duration ---------- */
async function captureThumbnail(url){
  return new Promise((resolve) => {
    const v = document.createElement('video');
    v.crossOrigin = "anonymous";
    v.muted = true;
    v.preload = 'metadata';
    v.src = url;

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    let resolved = false;
    const cleanup = ()=>{ try{ v.src=''; v.load(); }catch(e){} };

    v.addEventListener('loadedmetadata', () => {
      const t = Math.max(0.1, (v.duration || 0) * 0.25);
      canvas.width = Math.min(480, v.videoWidth || 480);
      canvas.height = Math.round(canvas.width * ((v.videoHeight||270)/(v.videoWidth||480)));
      function onSeek(){
        try{
          ctx.drawImage(v, 0, 0, canvas.width, canvas.height);
          const dataUrl = canvas.toDataURL('image/jpeg', 0.75);
          if(!resolved){ resolved = true; cleanup(); resolve({thumb:dataUrl, width:v.videoWidth, height:v.videoHeight, duration:v.duration}); }
        }catch(e){
          if(!resolved){ resolved=true; cleanup(); resolve({thumb:null, width:v.videoWidth, height:v.videoHeight, duration:v.duration}); }
        }
      }
      v.currentTime = Math.min(t, v.duration || t);
      v.addEventListener('seeked', onSeek, {once:true});
      setTimeout(()=>{ if(!resolved){ try{ ctx.drawImage(v,0,0,canvas.width,canvas.height);}catch(_){} resolved=true; cleanup(); resolve({thumb:canvas.toDataURL('image/jpeg',0.7), width:v.videoWidth, height:v.videoHeight, duration:v.duration}); } }, 900);
    });

    v.addEventListener('error', ()=>{ if(!resolved){ resolved=true; cleanup(); resolve({thumb:null,width:0,height:0,duration:0}); }});
  });
}

/* ---------- Estimate FPS (best-effort) ---------- */
async function estimateFPS(fileUrl, duration){
  return new Promise((resolve)=>{
    try{
      const v = document.createElement('video');
      v.preload='metadata';
      v.muted=true;
      v.src = fileUrl;
      v.addEventListener('loadedmetadata', ()=>{
        const tryMeasure = ()=>{
          try{
            if(typeof v.getVideoPlaybackQuality === 'function'){
              const q = v.getVideoPlaybackQuality();
              if(q && q.totalVideoFrames && duration > 0){
                const fps = Math.round(q.totalVideoFrames / duration);
                resolve(fps || 'Unknown'); v.src=''; return;
              }
            }
            const frames = v.webkitDecodedFrameCount || v.mozPaintCount || 0;
            if(frames && duration>0){ resolve(Math.round(frames/duration) || 'Unknown'); v.src=''; return; }
            resolve('Unknown'); v.src='';
          }catch(e){ resolve('Unknown'); v.src=''; }
        };
        v.play().then(()=>{ setTimeout(()=>{ v.pause(); tryMeasure(); }, 300); }).catch(()=>{ tryMeasure(); });
      });
      v.addEventListener('error', ()=>resolve('Unknown'));
    }catch(e){ resolve('Unknown'); }
  });
}

/* ---------- Build card ---------- */
function buildCard(item, idx){
  const isVideo = item.file.type.startsWith('video/');
  const card = document.createElement('div'); card.className = 'card' + (isListView ? ' row' : '');

  const thumbWrap = document.createElement('div'); thumbWrap.className = 'thumb-wrap';
  const img = document.createElement('img'); img.className = 'thumb'; img.alt = item.file.name;
  if(item.thumbUrl) img.src = item.thumbUrl; else img.style.background = '#000';
  thumbWrap.appendChild(img);
  const durBadge = document.createElement('div'); durBadge.className = 'duration-badge'; durBadge.textContent = item.metadata.duration ? formatTime(item.metadata.duration) : '00:00';
  thumbWrap.appendChild(durBadge);

  // watched progress bar
  const watchedWrap = document.createElement('div'); watchedWrap.className = 'watched-bar-wrap';
  const watchedBar = document.createElement('div'); watchedBar.className = 'watched-bar';
  // compute percent
  const percent = (item.metadata.duration && item.playedSeconds) ? Math.min(100, (item.playedSeconds / item.metadata.duration) * 100) : 0;
  watchedBar.style.width = percent + '%';
  watchedWrap.appendChild(watchedBar);
  thumbWrap.appendChild(watchedWrap);

  const meta = document.createElement('div'); meta.className = 'meta';
  const title = document.createElement('h3'); title.textContent = item.file.name;
  const tagRow = document.createElement('div'); tagRow.className = 'tags';
  const tagType = document.createElement('span'); tagType.className='tag'; tagType.textContent = item.file.type.split('/')[0].toUpperCase();
  tagRow.appendChild(tagType);

  // detail row: size, date, played time (we removed length,res,fps)
  const details = document.createElement('div'); details.className = 'detail-row';
  const sizeEl = document.createElement('div'); sizeEl.textContent = 'Size: ' + formatBytes(item.file.size);
  const dateEl = document.createElement('div'); dateEl.textContent = 'Date: ' + new Date(item.file.lastModified).toLocaleDateString();
  const playedEl = document.createElement('div'); playedEl.textContent = 'Played: ' + (item.playedSeconds? formatTime(item.playedSeconds) : '0:00');
  details.append(sizeEl, dateEl, playedEl);

  meta.append(title, tagRow, details);

  // clicking opens popup player only (no inline play)
  const openPlayer = (e)=>{
    e.stopPropagation();
    openInPlayer(idx);
  };
  thumbWrap.addEventListener('click', openPlayer);
  meta.addEventListener('click', openPlayer);

  card.appendChild(thumbWrap);
  card.appendChild(meta);
  card.style.opacity = 0; setTimeout(()=>{ card.style.opacity = 1; }, 40);
  return card;
}

/* ---------- Render gallery ---------- */
function renderGallery(){
  galleryEl.innerHTML = '';
  const filter = typeFilter.value;
  let toShow = allFiles.filter(it => (filter === 'all' ? true : it.file.type.startsWith(filter)));
  const sortBy = sortSelect.value;

  toShow.sort((a,b)=>{
    if(sortBy === 'title') return a.file.name.localeCompare(b.file.name);
    if(sortBy === 'type') return a.file.type.localeCompare(b.file.type);
    if(sortBy === 'date') return a.file.lastModified - b.file.lastModified;
    if(sortBy === 'size') return a.file.size - b.file.size;
    if(sortBy === 'length'){
      const da = a.metadata.duration || 0, db = b.metadata.duration || 0; return da - db;
    }
    return 0;
  });

  galleryEl.classList.toggle('list', isListView);
  toShow.forEach((it, idx) => {
    const card = buildCard(it, idx);
    if(isListView) card.classList.add('row');
    galleryEl.appendChild(card);
  });
}

/* ---------- Open item in overlay player ---------- */
function openInPlayer(index){
  const item = allFiles[index];
  if(!item) return;
  player.pause(); audioPlayer.pause();
  player.removeAttribute('src'); audioPlayer.removeAttribute('src');
  const url = item.url;
  const isVideo = item.file.type.startsWith('video/');
  playerContainer.style.display = 'flex';
  playerContainer.setAttribute('aria-hidden','false');

  if(isVideo){
    audioPlayer.style.display = 'none';
    player.style.display = 'block';
    player.src = url;
    const start = loadPlayedPosition(item.file) || item.playedSeconds || 0;
    try{ player.currentTime = start; }catch(e){}
    player.play().catch(()=>{ /* may be blocked until user interacts but popup click is gesture */});
    player.ontimeupdate = ()=> {
      item.playedSeconds = player.currentTime;
      savePlayedPosition(item.file, player.currentTime);
      updateWatchedBar(item);
    };
    player.onended = ()=>{ item.playedSeconds = item.metadata.duration || 0; savePlayedPosition(item.file, item.playedSeconds); updateWatchedBar(item); };
    playerMeta.textContent = `${item.file.name} ‚Ä¢ ${item.file.size ? formatBytes(item.file.size) : ''}`;
  } else {
    player.style.display = 'none';
    audioPlayer.style.display = 'block';
    audioPlayer.src = url;
    const start = loadPlayedPosition(item.file) || item.playedSeconds || 0;
    try{ audioPlayer.currentTime = start; }catch(e){}
    audioPlayer.play().catch(()=>{ /* may require user gesture */});
    audioPlayer.ontimeupdate = ()=> {
      item.playedSeconds = audioPlayer.currentTime;
      savePlayedPosition(item.file, audioPlayer.currentTime);
      updateWatchedBar(item);
    };
    audioPlayer.onended = ()=>{ item.playedSeconds = item.metadata.duration || 0; savePlayedPosition(item.file, item.playedSeconds); updateWatchedBar(item); };
    playerMeta.textContent = `${item.file.name} ‚Ä¢ Audio ‚Ä¢ ${item.file.size ? formatBytes(item.file.size) : ''}`;
  }
}

/* ---------- Update watched bar for a single item ---------- */
function updateWatchedBar(item){
  // find its card in DOM by matching filename; quicker approach would use dataset keys
  const cards = Array.from(galleryEl.querySelectorAll('.card'));
  for(const card of cards){
    const title = card.querySelector('.meta h3');
    if(title && title.textContent === item.file.name){
      const bar = card.querySelector('.watched-bar');
      if(bar && item.metadata.duration){
        const pct = Math.min(100, ((item.playedSeconds || 0) / item.metadata.duration) * 100);
        bar.style.width = pct + '%';
      }
      const playedEl = card.querySelector('.detail-row div:nth-child(3)');
      if(playedEl) playedEl.textContent = 'Played: ' + (item.playedSeconds? formatTime(item.playedSeconds) : '0:00');
      break;
    }
  }
}

/* ---------- Input handlers & ingestion ---------- */
fileInput.addEventListener('change', async (e)=>{
  const files = Array.from(e.target.files || []);
  await ingestFiles(files);
});
folderInput.addEventListener('change', async (e)=>{
  const files = Array.from(e.target.files || []);
  await ingestFiles(files);
});

typeFilter.addEventListener('change', renderGallery);
sortSelect.addEventListener('change', renderGallery);

/* view/theme toggles */
viewToggle.addEventListener('click', ()=>{
  isListView = !isListView;
  viewToggle.textContent = isListView ? 'üìã List' : 'üî≤ Grid';
  viewIndicator.querySelector('.icon').textContent = isListView ? 'üìã' : 'üî≤';
  renderGallery();
});
themeToggle.addEventListener('click', ()=>{
  isLight = !isLight;
  document.body.classList.toggle('light', isLight);
  themeToggle.textContent = isLight ? '‚òÄÔ∏è Light' : 'üåô Dark';
  themeIndicator.querySelector('.icon').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
});

/* player close */
closeBtn.addEventListener('click', ()=>{
  try{ player.pause(); audioPlayer.pause(); }catch(e){}
  playerContainer.style.display = 'none';
});

/* ---------- Ingest files (metadata + thumbnail) ---------- */
async function ingestFiles(fileList){
  for(const f of fileList){
    if(!f.type || (!f.type.startsWith('video/') && !f.type.startsWith('audio/'))) continue;
    // skip if already exists (by fingerprint)
    const key = fileKey(f);
    if(allFiles.some(x=>fileKey(x.file)===key)) continue;

    const url = URL.createObjectURL(f);
    const entry = { file: f, url: url, metadata: {}, thumbUrl: null, playedSeconds: loadPlayedPosition(f) || 0 };

    // populate small metadata quickly
    entry.metadata.size = f.size;
    entry.metadata.date = f.lastModified;

    if(f.type.startsWith('video/')){
      try{
        const {thumb, width, height, duration} = await captureThumbnail(url);
        entry.thumbUrl = thumb;
        entry.metadata.width = width;
        entry.metadata.height = height;
        entry.metadata.duration = duration || 0;
      }catch(e){
        entry.thumbUrl = null;
        entry.metadata.duration = 0;
      }
      // try FPS best-effort (optional, but we are removing display)
      entry.metadata.fps = await estimateFPS(url, entry.metadata.duration).catch(()=> 'Unknown');
    } else {
      // audio
      const a = document.createElement('audio'); a.preload='metadata'; a.src = url;
      await new Promise((res)=>{ a.addEventListener('loadedmetadata', ()=>res(), {once:true}); a.addEventListener('error', ()=>res(), {once:true}); });
      entry.metadata.duration = a.duration || 0;
      entry.thumbUrl = null;
    }

    allFiles.push(entry);
    renderGallery();
  }
}

/* ---------- estimateFPS helper used earlier ---------- */
async function estimateFPS(fileUrl, duration){
  return new Promise((resolve)=>{
    try{
      const v = document.createElement('video');
      v.preload='metadata';
      v.muted=true;
      v.src = fileUrl;
      v.addEventListener('loadedmetadata', ()=>{
        const tryMeasure = ()=>{
          try{
            if(typeof v.getVideoPlaybackQuality === 'function'){
              const q = v.getVideoPlaybackQuality();
              if(q && q.totalVideoFrames && duration > 0){ const fps = Math.round(q.totalVideoFrames / duration); resolve(fps || 'Unknown'); v.src=''; return; }
            }
            const frames = v.webkitDecodedFrameCount || v.mozPaintCount || 0;
            if(frames && duration>0){ resolve(Math.round(frames/duration) || 'Unknown'); v.src=''; return; }
            resolve('Unknown'); v.src='';
          }catch(e){ resolve('Unknown'); v.src=''; }
        };
        v.play().then(()=>{ setTimeout(()=>{ v.pause(); tryMeasure(); }, 300); }).catch(()=>{ tryMeasure(); });
      });
      v.addEventListener('error', ()=>resolve('Unknown'));
    }catch(e){ resolve('Unknown'); }
  });
}

/* ---------- Update watched bars initially from saved positions ---------- */
function applySavedPositions(){
  for(const it of allFiles){
    const saved = loadPlayedPosition(it.file);
    if(saved) it.playedSeconds = saved;
  }
}

/* ---------- Cleanup on unload ---------- */
window.addEventListener('beforeunload', ()=>{
  allFiles.forEach(it => { try{ URL.revokeObjectURL(it.url); }catch(e){} });
});

/* ---------- Keyboard accessibility ---------- */
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ if(playerContainer.style.display === 'flex') closeBtn.click(); } });

/* init */
(function init(){
  viewToggle.textContent = 'üî≤ Grid';
  themeToggle.textContent = 'üåô Dark';
  themeIndicator.querySelector('.icon').textContent = 'üåô';
  viewIndicator.querySelector('.icon').textContent = 'üî≤';
})();
</script>
</body>
</html>
